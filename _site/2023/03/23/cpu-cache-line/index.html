<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Module exponentiation</title>
    <meta name="description" content="之前在阅读别人的代码时，发现了一个有趣的现象，那就是在多核环境下，对于一个64字节的结构体，如果其成员变量不是64字节对齐的，那么在多核环境下，对其进行读写操作时，会出现性能下降的情况。这篇文章就来探究一下。">

    <link rel="shortcut icon" href="/favicon.ico?" type="image/x-icon">
    <link rel="icon" href="/favicon.ico?" type="image/x-icon">
    <link rel="stylesheet" href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://at.alicdn.com/t/font_8v3czwksspqlg14i.css">
    <link rel="stylesheet" href="/css/main.css ">
    <link rel="canonical" href="http://localhost:4000/2023/03/23/cpu-cache-line/">
    <link rel="alternate" type="application/rss+xml" title="zengzzzzz" href="http://localhost:4000/feed.xml ">


    <script>
    // 百度统计代码
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
    </script>



<script async src="https://www.googletagmanager.com/gtag/js?id=G-LEFXXJK1Z8"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-LEFXXJK1Z8');
</script>


</head>


  <body>

    <header id="top">
    <div class="wrapper">
        <a href="/" class="brand">zengzzzzz</a>
        <small>the more you know, the less you know</small>
        <button id="headerMenu" class="menu"><i class="fa fa-bars"></i></button>
        <nav id="headerNav">
            <ul>
                <li>
                    
                    <a href="/">
                    
                        <i class="fa fa-home"></i>Home
                    </a>
                </li>

                
                    
                    <li>
                        
                        <a href="/archive/">
                        
                            <i class="fa fa-archive"></i>Archives
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/category/">
                        
                            <i class="fa fa-th-list"></i>Categories
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/tag/">
                        
                            <i class="fa fa-tags"></i>Tags
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/collection/">
                        
                            <i class="fa fa-bookmark"></i>Collections
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/about/">
                        
                            <i class="fa fa-heart"></i>About
                        </a>
                    </li>
                    
                
                    
                
                    
                
                    
                
            </ul>
        </nav>
    </div>
</header>


        <div class="page clearfix" post>
    <div class="left">
        <h1>Module exponentiation</h1>
        <div class="label">

            <div class="label-card">
                <i class="fa fa-calendar"></i>2023-03-23
            </div>

            <div class="label-card">
                
            </div>

            <div class="label-card">
                
            </div>

            <div class="label-card">
            


<!-- <span class="point">•</span> -->
<span class="categories">
  <i class="fa fa-th-list"></i>
  
    
        <a href="/category/#algorithm" title="Category: algorithm" rel="category">algorithm</a>
    
  

  <!-- <span class="point">•</span> -->
</span>


            </div>

            <div class="label-card">
            
<!-- <span class="point">•</span> -->
<span class="pageTag">
  <i class="fa fa-tags"></i>
  
    
        <!--a href="/tag/#modular" title="Tag: modular" rel="tag">modular</a-->
        <a href="/tag/#modular" title="Tag: modular" rel="tag">modular</a>&nbsp;
    
        <!--a href="/tag/#exponentiation" title="Tag: exponentiation" rel="tag">exponentiation</a-->
        <a href="/tag/#exponentiation" title="Tag: exponentiation" rel="tag">exponentiation</a>
    
  

</span>

            </div>

        </div>
        <hr>
        <article itemscope itemtype="http://schema.org/BlogPosting">
        <ul id="markdown-toc">
  <li><a href="#多核环境下cache-line-测试" id="markdown-toc-多核环境下cache-line-测试">多核环境下cache line 测试</a></li>
  <li><a href="#cpu-cache-简介" id="markdown-toc-cpu-cache-简介">CPU CACHE 简介</a></li>
  <li><a href="#场景测试" id="markdown-toc-场景测试">场景测试</a>    <ul>
      <li><a href="#场景设定" id="markdown-toc-场景设定">场景设定</a></li>
      <li><a href="#测试代码" id="markdown-toc-测试代码">测试代码</a></li>
      <li><a href="#测试结论" id="markdown-toc-测试结论">测试结论</a></li>
    </ul>
  </li>
  <li><a href="#总结" id="markdown-toc-总结">总结</a>    <ul>
      <li><a href="#参考文章" id="markdown-toc-参考文章">参考文章</a></li>
    </ul>
  </li>
</ul>

<p>之前在阅读别人的代码时，发现了一个有趣的现象，那就是在多核环境下，对于一个64字节的结构体，如果其成员变量不是64字节对齐的，那么在多核环境下，对其进行读写操作时，会出现性能下降的情况。这篇文章就来探究一下。</p>

<h2 id="多核环境下cache-line-测试">多核环境下cache line 测试</h2>

<p>前段时间在阅读 <a href="https://github.com/zengzzzzz/ratelimit/blob/main/limiter_atomic_int64.go">uber/rat_limit</a> 代码时注意到其在定义struct时，会填入补充字段补至 64 byte来避免 cache line 的 false sharing，于是决定花些时间来探究一下其原理。</p>

<div class="language-golang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span> <span class="n">atomicLimiter</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">state</span>      <span class="n">unsafe</span><span class="o">.</span><span class="n">Pointer</span>
	<span class="n">padding</span>    <span class="p">[</span><span class="m">56</span><span class="p">]</span><span class="kt">byte</span> <span class="c">// cache line size - state pointer size = 64 -8 ; created to avoid false sharing</span>
	<span class="n">perRequest</span> <span class="n">time</span><span class="o">.</span><span class="n">Duration</span>
	<span class="n">maxSlack</span>   <span class="n">time</span><span class="o">.</span><span class="n">Duration</span>
	<span class="n">clock</span>      <span class="n">Clock</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="cpu-cache-简介">CPU CACHE 简介</h2>

<p>通常情况下，我们无法直接干预对缓存的操作，但可以根据缓存的特点对程序代码实施特定优化，从而更好的利用高速缓存。高速缓存策略会尽可能地将访问频繁的数据放入cache中，该过程是动态的，cache中的数据不会一直不变，目前一般机器的CPU cache 可分为一级、二级、三级缓存，较旧的机器可能只有二级缓存。该缓存和RAM在空间和效率上的关系如下：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>     CPU
      |
      |  Fastest          Small
      | -----------------------  Level 1 Cache (L1)
      |                         |
      |  Faster               Small
      | -----------------------  Level 2 Cache (L2)
      |                         |
      |  Fast                 Small
      | -----------------------  Level 3 Cache (L3)
      |                         |
      |  Slowest              Large
      | -----------------------  Main Memory (RAM) cache 简单示意图：
</code></pre></div></div>

<p><img src="https://raw.githubusercontent.com/zengzzzzz/zengzzzzz-img/main/cpu_cache/cpu_cache_architecture.png" alt="image" /></p>

<p>在lunix上可以使用lscpu来查看 cpu cache 的信息：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>admin@al-hk-test-risk-app001:~$ lscpu
Architecture:        x86_64
CPU op-mode(s):      32-bit, 64-bit
Byte Order:          Little Endian
CPU(s):              8
On-line CPU(s) list: 0-7
Thread(s) per core:  2
Core(s) per socket:  4
Socket(s):           1
NUMA node(s):        1
Vendor ID:           GenuineIntel
CPU family:          6
Model:               85
Model name:          Intel(R) Xeon(R) Platinum 8163 CPU @ 2.50GHz
Stepping:            4
CPU MHz:             2499.996
BogoMIPS:            4999.99
Hypervisor vendor:   KVM
Virtualization type: full
L1d cache:           32K # 一级数据缓存
L1i cache:           32K # 一级指令缓存
L2 cache:            1024K
L3 cache:            33792K
NUMA node0 CPU(s):   0-7
</code></pre></div></div>

<p>说明该机器为8核且存在三级缓存，由于不同处理器之间都具有自己的高速缓存，所以当俩个cpu cache中都存有数据a，就有可能需要进行同步数据。而cache直接进行同步数据的最小单元为cache行大小，每一行cache的大小都是64bytes，当cpu 被告知 cache 第一行的第一个byte 为脏数据时，cpu会将每一行都进行同步。</p>

<h2 id="场景测试">场景测试</h2>

<p>在cpu 高速缓存中存在以下规则，当一个CPU修改高速缓存行中的字节时，计算机中的其他CPU会被通知，其cache被视为无效。</p>

<h3 id="场景设定">场景设定</h3>

<p>CPU1 读取数据a（a小于cache行大小），存入CPU1高速缓存；CPU2 读取数据a，并存入CPU2高速缓存；CPU1 修改数据a，a被放回CPU1高速缓存行，但该信息不会写入RAM；CPU2访问数据a时，发现其高速缓存已经失效，需要CPU1将数据a写回RAM中，然后CPU2重新读取该数据，可完成一次俩个CPU之间cache的同步。</p>

<h3 id="测试代码">测试代码</h3>

<p>自己采用了golang进行测试上述问题，选择的方法主要采用了在runtime时，限制CPU核数的方式来指定是相同CPU，还是不同的CPU运行；读者也可以尝试使用golang中<a href="https://pkg.go.dev/golang.org/x/sys/unix#SchedSetaffinity">设置CPU亲和性</a>的方式来指定CPU运行，其效果应该是一致的。</p>

<p><a href="https://github.com/zengzzzzz/algorithm/blob/main/cpu_cache/cpu_cache.go">测试代码</a>如下：</p>

<div class="language-golang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">/*
 * @Author: zengzh
 * @Date: 2023-04-03 16:02:28
 * @Last Modified by: zengzh
 * @Last Modified time: 2023-04-03 16:50:49
 */</span>

<span class="c">// https://www.duguying.net/article/set-cpu-affinity-binding-for-golang-program</span>
<span class="k">package</span> <span class="n">cpu_cache</span>

<span class="k">import</span> <span class="p">(</span>
	<span class="c">// "fmt"</span>
	<span class="s">"runtime"</span>
	<span class="s">"sync"</span>
	<span class="c">// "time"</span>
<span class="p">)</span>

<span class="k">const</span> <span class="p">(</span>
	<span class="n">execCount</span> <span class="o">=</span> <span class="m">100</span> <span class="o">*</span> <span class="m">1000</span> <span class="o">*</span> <span class="m">1000</span>
<span class="p">)</span>

<span class="k">type</span> <span class="n">Bits</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">a</span> <span class="kt">int</span>
	<span class="n">b</span> <span class="kt">int</span>
<span class="p">}</span>

<span class="k">type</span> <span class="n">BitsWithCache</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">a</span> <span class="kt">int</span>
	<span class="n">placeholder</span> <span class="p">[</span><span class="m">64</span><span class="p">]</span><span class="kt">byte</span>
	<span class="n">b</span> <span class="kt">int</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">SetCPUCore</span><span class="p">(</span><span class="n">num</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">runtime</span><span class="o">.</span><span class="n">GOMAXPROCS</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">thdFunc1</span><span class="p">(</span><span class="n">wg</span> <span class="o">*</span><span class="n">sync</span><span class="o">.</span><span class="n">WaitGroup</span><span class="p">,</span> <span class="n">bits</span> <span class="o">*</span><span class="n">Bits</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">defer</span> <span class="n">wg</span><span class="o">.</span><span class="n">Done</span><span class="p">()</span>
	<span class="c">// begin := time.Now()</span>

	<span class="k">for</span> <span class="n">i</span> <span class="o">:=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">execCount</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">{</span>
		<span class="n">bits</span><span class="o">.</span><span class="n">a</span> <span class="o">+=</span> <span class="m">1</span>
		<span class="n">a</span> <span class="o">:=</span> <span class="n">bits</span><span class="o">.</span><span class="n">a</span>
		<span class="n">_</span> <span class="o">=</span> <span class="n">a</span>
	<span class="p">}</span>

	<span class="c">// end := time.Now()</span>
	<span class="c">// fmt.Printf("thd1 perf:[%d]us\n", end.Sub(begin)/time.Microsecond)</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">thdFunc2</span><span class="p">(</span><span class="n">wg</span> <span class="o">*</span><span class="n">sync</span><span class="o">.</span><span class="n">WaitGroup</span><span class="p">,</span> <span class="n">bits</span> <span class="o">*</span><span class="n">BitsWithCache</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">defer</span> <span class="n">wg</span><span class="o">.</span><span class="n">Done</span><span class="p">()</span>
	<span class="c">// begin := time.Now()</span>

	<span class="k">for</span> <span class="n">i</span> <span class="o">:=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">execCount</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">{</span>
		<span class="n">bits</span><span class="o">.</span><span class="n">a</span> <span class="o">+=</span> <span class="m">1</span>
		<span class="n">a</span> <span class="o">:=</span> <span class="n">bits</span><span class="o">.</span><span class="n">a</span>
		<span class="n">_</span> <span class="o">=</span> <span class="n">a</span>
	<span class="p">}</span>

	<span class="c">// end := time.Now()</span>
	<span class="c">// fmt.Printf("thd1 perf:[%d]us\n", end.Sub(begin)/time.Microsecond)</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">thdFunc3</span><span class="p">(</span><span class="n">wg</span> <span class="o">*</span><span class="n">sync</span><span class="o">.</span><span class="n">WaitGroup</span><span class="p">,</span> <span class="n">bits</span> <span class="o">*</span><span class="n">Bits</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">defer</span> <span class="n">wg</span><span class="o">.</span><span class="n">Done</span><span class="p">()</span>
	<span class="c">// begin := time.Now()</span>

	<span class="k">for</span> <span class="n">i</span> <span class="o">:=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">execCount</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">{</span>
		<span class="n">bits</span><span class="o">.</span><span class="n">b</span> <span class="o">+=</span> <span class="m">2</span>
		<span class="n">b</span> <span class="o">:=</span> <span class="n">bits</span><span class="o">.</span><span class="n">b</span>
		<span class="n">_</span> <span class="o">=</span> <span class="n">b</span>
	<span class="p">}</span>

	<span class="c">// end := time.Now()</span>
	<span class="c">// fmt.Printf("thd2 perf:[%d]us\n", end.Sub(begin)/time.Microsecond)</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">thdFunc4</span><span class="p">(</span><span class="n">wg</span> <span class="o">*</span><span class="n">sync</span><span class="o">.</span><span class="n">WaitGroup</span><span class="p">,</span> <span class="n">bits</span> <span class="o">*</span><span class="n">BitsWithCache</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">defer</span> <span class="n">wg</span><span class="o">.</span><span class="n">Done</span><span class="p">()</span>
	<span class="c">// begin := time.Now()</span>

	<span class="k">for</span> <span class="n">i</span> <span class="o">:=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">execCount</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">{</span>
		<span class="n">bits</span><span class="o">.</span><span class="n">b</span> <span class="o">+=</span> <span class="m">2</span>
		<span class="n">b</span> <span class="o">:=</span> <span class="n">bits</span><span class="o">.</span><span class="n">b</span>
		<span class="n">_</span> <span class="o">=</span> <span class="n">b</span>
	<span class="p">}</span>

	<span class="c">// end := time.Now()</span>
	<span class="c">// fmt.Printf("thd2 perf:[%d]us\n", end.Sub(begin)/time.Microsecond)</span>
<span class="p">}</span>

</code></pre></div></div>
<p>该代码为了方便测试和更直观展示，特意将测试部分细分为四个函数，同时为了避免其他因素等干扰，并没有采用泛型或者反射的写法，最少的减少其他因素的影响。在该测试代码中，与uber rate limit 中采用不一致的写法，uber 中的写法，是将结构体补充为 64byte 刚好占满一个 cache line，我们这里为了更加直观的展示，是将a，b中间填充一行，使得 a b placeholder 分别位于不同的cache line，若没有 placeholder 填充中间一行的话，a b将位于同一cache line，便会出现上述 cpu cache line 失效的问题。</p>

<p>分别对以下情况进行测试：</p>
<ol>
  <li>跑在俩个CPU上（该处没有严格指定CPU），没有填充placeholder</li>
  <li>跑在俩个CPU上（该处没有严格指定CPU），填充placeholder</li>
  <li>跑在一个CPU上，没有填充placeholder</li>
  <li>跑在一个CPU上，填充placeholder</li>
</ol>

<p>测试结果如下：
<img src="https://raw.githubusercontent.com/zengzzzzz/zengzzzzz-img/main/cpu_cache/bench_cpu_cache_test.png" alt="image" /></p>

<h3 id="测试结论">测试结论</h3>

<p>综上，虽在测试时，并未严格指定运行的CPU，但是在其结果中可看出 情况1 2下，有无填充placeholder是存在明显区别的。而情况3 4下，无论有无填充placeholder，其结果都是一致的，这是因为情况3 4下，其实是在同一个CPU上运行，是不存在cache line失效的问题，但会比情况1慢一些，是因为只指定了一个CPU运行的。</p>

<h2 id="总结">总结</h2>

<p>其实在日常工作中，某些对于CPU cache的优化还是比较重要的，但是在这个过程中如果为了追求性能将所有的共享字节都填入填充字节，可能会带来空间的浪费。在某些不同的硬件体系架构下，cache line的大小可能会不一样，或者可能会共享cache等等，所以在测试时要视具体情况而定的。</p>
<h4 id="参考文章">参考文章</h4>

<p>https://www.makeuseof.com/tag/what-is-cpu-cache/</p>

<p>https://github.com/zengzzzzz/ratelimit/blob/main/limiter_atomic_int64.go</p>

<p>https://cloud.tencent.com/developer/article/1021491</p>


        </article>
        <hr>

        
        
            
            
                
                    
                
                    
                
            
                
                    
                
                    
                
            
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
            
                
                    
                
                    
                
            
        
        

        <div class="post-recent">
    <div class="pre">
        
        <p><strong>上一篇</strong> <a href="/2023/03/15/jwt-hsa256/">JWT SHA256</a></p>
        
    </div>
    <div class="nex">

        
    </div>
</div>


        <h2 id="comments">Comments</h2>
        


<div id="disqus_thread"></div>
<script>
    /**
     * RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     * LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */

    var disqus_config = function() {
        this.page.url = 'http://localhost:4000/2023/03/23/cpu-cache-line/'; // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = 'http://localhost:4000/2023/03/23/cpu-cache-line/'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };

    (function() { // DON'T EDIT BELOW THIS LINE
        var d = document,
            s = d.createElement('script');

        s.src = '//zengzzzzz.disqus.com/embed.js';

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>




    </div>
    <button class="anchor"><i class="fa fa-anchor"></i></button>
    <div class="right">
        <div class="wrap">

            <!-- Content -->
            <div class="side content">
                <div>
                    Content
                </div>
                <ul id="content-side" class="content-ul">
                    
                    <li><a href="#comments">Comments</a></li>
                </ul>
            </div>
            <!-- 其他div框放到这里 -->
            <!-- <div class="side">bbbb</div> -->
        </div>
    </div>
</div>
<script>
/**
 * target _blank
 */
(function() {
    var aTags = document.querySelectorAll('article a:not([id])')
    for (var i = 0; i < aTags.length; i++) {
        aTags[i].setAttribute('target', '_blank')
    }
}());
</script>
<script src="/js/pageContent.js " charset="utf-8"></script>


    <footer class="site-footer">


    <div class="wrapper">

        <p class="description">
             zengzzzzz 
        </p>
        <p class="contact">
            Contact me at: 
            <a href="https://github.com/zengzzzzz" title="GitHub"><i class="fa fa-github" aria-hidden="true"></i></a>  
            <a href="mailto:zengzzzzz@gmail.com" title="email"><i class="fa fa-envelope-o" aria-hidden="true"></i></a>        
        </p>
        <p>
            <!-- 本站总访问量<span id="busuanzi_value_site_pv"></span>次，本站访客数<span id="busuanzi_value_site_uv"></span>人次，本文总阅读量<span id="busuanzi_value_page_pv"></span>次 -->
        </p>
        <p class="power">
            <span>
                Site powered by <a href="https://jekyllrb.com/">Jekyll</a> & <a href="https://pages.github.com/">Github Pages</a> & <a href="https://github.com/Gaohaoyang">HyG</a>.
            </span>
        </p>
    </div>
</footer>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

    <div class="back-to-top">
    <a href="#top" data-scroll>
        <i class="fa fa-arrow-up" aria-hidden="true"></i>
    </a>
</div>

    <script src=" /js/main.js " charset="utf-8"></script>
    <script src=" /js/smooth-scroll.min.js " charset="utf-8"></script>
    <script type="text/javascript">
      smoothScroll.init({
        speed: 500, // Integer. How fast to complete the scroll in milliseconds
        easing: 'easeInOutCubic', // Easing pattern to use
        offset: 20, // Integer. How far to offset the scrolling anchor location in pixels
      });
    </script>
    <!-- <script src=" /js/scroll.min.js " charset="utf-8"></script> -->
  </body>

</html>
